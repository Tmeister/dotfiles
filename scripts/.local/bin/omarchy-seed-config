#!/usr/bin/env bash
#
# omarchy-seed-config - Inject dotfiles override sources into hyprland.conf
#
# This script adds source lines for your custom override files to hyprland.conf
# It's idempotent (safe to run multiple times) and creates backups
#
# Usage:
#   omarchy-seed-config           # Seed hyprland.conf with overrides
#   omarchy-seed-config --check   # Just check if already seeded
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

HYPRLAND_CONF="$HOME/.config/hypr/hyprland.conf"
OVERRIDE_DIR="$HOME/.config/hypr/overrides"
OMARCHY_DIR="$HOME/.local/share/omarchy"

# Marker to detect if already seeded
SEED_MARKER="# DOTFILES OVERRIDES - Managed by omarchy-seed-config"

show_usage() {
    echo -e "${BLUE}omarchy-seed-config${NC} - Inject dotfiles overrides into hyprland.conf"
    echo ""
    echo "Usage:"
    echo "  omarchy-seed-config           # Seed hyprland.conf with override sources"
    echo "  omarchy-seed-config --check   # Check if already seeded"
    echo "  omarchy-seed-config --help    # Show this help"
    echo ""
}

check_seeded() {
    if [ ! -f "$HYPRLAND_CONF" ]; then
        return 1
    fi

    grep -q "$SEED_MARKER" "$HYPRLAND_CONF"
}

verify_omarchy() {
    echo -e "${YELLOW}[1/5]${NC} Verifying omarchy installation..."

    if [ ! -d "$OMARCHY_DIR" ]; then
        echo -e "${RED}✗ Omarchy not found at $OMARCHY_DIR${NC}"
        echo ""
        echo "Omarchy must be installed first. Visit:"
        echo "  https://omarch.io"
        exit 1
    fi

    if [ ! -f "$HYPRLAND_CONF" ]; then
        echo -e "${RED}✗ hyprland.conf not found at $HYPRLAND_CONF${NC}"
        echo ""
        echo "Please ensure Hyprland is configured."
        exit 1
    fi

    echo -e "${GREEN}✓ Omarchy installed${NC}"
    echo -e "${GREEN}✓ hyprland.conf exists${NC}"
    echo ""
}

check_already_seeded() {
    echo -e "${YELLOW}[2/5]${NC} Checking if already seeded..."

    if check_seeded; then
        echo -e "${CYAN}→ Override sources already present in hyprland.conf${NC}"
        echo -e "${CYAN}→ Nothing to do (idempotent operation)${NC}"
        echo ""
        echo -e "${GREEN}✓ Config already seeded${NC}"
        exit 0
    fi

    echo -e "${GREEN}✓ Ready to seed${NC}"
    echo ""
}

backup_config() {
    echo -e "${YELLOW}[3/5]${NC} Creating backup..."

    local backup_file="${HYPRLAND_CONF}.backup-$(date +%Y%m%d-%H%M%S)"

    if cp "$HYPRLAND_CONF" "$backup_file"; then
        echo -e "${GREEN}✓ Backup created: ${backup_file/#$HOME/~}${NC}"
    else
        echo -e "${RED}✗ Failed to create backup${NC}"
        exit 1
    fi

    echo ""
}

inject_overrides() {
    echo -e "${YELLOW}[4/5]${NC} Injecting override sources..."

    # Find the line with omarchy theme source (last omarchy source)
    local theme_line
    theme_line=$(grep -n "source = ~/.config/omarchy/current/theme/hyprland.conf" "$HYPRLAND_CONF" | cut -d: -f1)

    if [ -z "$theme_line" ]; then
        echo -e "${RED}✗ Could not find omarchy theme source line${NC}"
        echo "  Expected: source = ~/.config/omarchy/current/theme/hyprland.conf"
        exit 1
    fi

    # Create the override sources block
    local override_block="
$SEED_MARKER
# These overrides are sourced AFTER omarchy defaults, so they take precedence
# They are managed by your dotfiles and protected from omarchy updates
source = ~/.config/hypr/overrides/bindings.conf
source = ~/.config/hypr/overrides/monitors.conf
source = ~/.config/hypr/overrides/workspaces.conf
source = ~/.config/hypr/overrides/windows.conf
source = ~/.config/hypr/overrides/input.conf
source = ~/.config/hypr/overrides/envs.conf
source = ~/.config/hypr/overrides/autostart.conf
"

    # Insert the block after the theme line
    local temp_file="${HYPRLAND_CONF}.tmp"
    {
        head -n "$theme_line" "$HYPRLAND_CONF"
        echo "$override_block"
        tail -n +$((theme_line + 1)) "$HYPRLAND_CONF"
    } > "$temp_file"

    if mv "$temp_file" "$HYPRLAND_CONF"; then
        echo -e "${GREEN}✓ Override sources injected${NC}"
        echo ""
        echo -e "${CYAN}Added 7 override source lines:${NC}"
        echo "  - bindings.conf (launcher, 75% keyboard, custom scripts)"
        echo "  - monitors.conf (dual monitor setup)"
        echo "  - workspaces.conf (workspace assignments)"
        echo "  - windows.conf (Vicinae, JetBrains fixes)"
        echo "  - input.conf (keyboard, mouse settings)"
        echo "  - envs.conf (font rendering, Java fixes)"
        echo "  - autostart.conf (Vicinae, cliphist)"
    else
        echo -e "${RED}✗ Failed to update hyprland.conf${NC}"
        exit 1
    fi

    echo ""
}

verify_result() {
    echo -e "${YELLOW}[5/5]${NC} Verifying configuration..."

    # Check that all override files exist
    local missing_files=()
    local override_files=(
        "bindings.conf"
        "monitors.conf"
        "workspaces.conf"
        "windows.conf"
        "input.conf"
        "envs.conf"
        "autostart.conf"
    )

    for file in "${override_files[@]}"; do
        if [ ! -f "$OVERRIDE_DIR/$file" ]; then
            missing_files+=("$file")
        fi
    done

    if [ ${#missing_files[@]} -gt 0 ]; then
        echo -e "${YELLOW}⚠ Warning: Some override files not found:${NC}"
        for file in "${missing_files[@]}"; do
            echo -e "    ${YELLOW}✗${NC} $OVERRIDE_DIR/$file"
        done
        echo ""
        echo "These will be created when you stow the hypr package:"
        echo "  cd ~/.dotfiles && stow hypr"
        echo ""
    fi

    # Check that seeding was successful
    if check_seeded; then
        echo -e "${GREEN}✓ Seed marker found in hyprland.conf${NC}"
        echo -e "${GREEN}✓ Configuration seeded successfully${NC}"
    else
        echo -e "${RED}✗ Verification failed${NC}"
        exit 1
    fi

    echo ""
}

show_summary() {
    echo -e "${BLUE}════════════════════════════════════${NC}"
    echo -e "${GREEN}✓ Omarchy config seeded successfully!${NC}"
    echo -e "${BLUE}════════════════════════════════════${NC}"
    echo ""
    echo -e "${CYAN}Next steps:${NC}"
    echo ""
    echo "1. Reload Hyprland configuration:"
    echo "   ${BLUE}hyprctl reload${NC}"
    echo ""
    echo "2. Or relaunch Hyprland:"
    echo "   ${BLUE}Super+Esc → Relaunch${NC}"
    echo ""
    echo "3. Verify your customizations work:"
    echo "   • ${CYAN}SUPER+SPACE${NC} - Vicinae launcher"
    echo "   • ${CYAN}HOME${NC} - Screenshot"
    echo "   • ${CYAN}SUPER+S${NC} - Resolution toggle"
    echo ""
    echo -e "${YELLOW}Note:${NC} Your override files are now protected from omarchy updates!"
    echo ""
}

# Main script
case "${1:-}" in
    --help|-h)
        show_usage
        exit 0
        ;;
    --check|-c)
        if check_seeded; then
            echo -e "${GREEN}✓ Config is already seeded${NC}"
            exit 0
        else
            echo -e "${YELLOW}⚠ Config not yet seeded${NC}"
            echo "Run without --check to seed the configuration"
            exit 1
        fi
        ;;
    "")
        # Normal seeding operation
        echo -e "${BLUE}╔══════════════════════════════════════════════════╗${NC}"
        echo -e "${BLUE}║     Omarchy Config Seeding - Dotfiles Setup      ║${NC}"
        echo -e "${BLUE}╚══════════════════════════════════════════════════╝${NC}"
        echo ""

        verify_omarchy
        check_already_seeded
        backup_config
        inject_overrides
        verify_result
        show_summary
        ;;
    *)
        echo -e "${RED}Unknown option: $1${NC}"
        echo ""
        show_usage
        exit 1
        ;;
esac
